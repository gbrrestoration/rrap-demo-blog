---
keywords: fastai
description: A tutorial of RRAP-IS system use from a modeller's perspective.   
title: RRAP-IS Modelling Workflow Demonstration Notebook
toc: true 
badges: true
comments: true
categories: [jupyter]
nb_path: _notebooks/2022-09-09-rrap-is-workflow.ipynb
layout: notebook
---

<!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-09-09-rrap-is-workflow.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="About">About<a class="anchor-link" href="#About"> </a></h2><p>This notebook is a demonstration of ... RRAP data repository.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Run-all-imports">Run all imports<a class="anchor-link" href="#Run-all-imports"> </a></h3><p>Keep all your imports at the top of a notebook.  It allows for easier management.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">IFrame</span><span class="p">,</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">JSON</span><span class="p">,</span> <span class="n">Markdown</span><span class="p">,</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">mdsisclienttools.auth.TokenManager</span> <span class="kn">import</span> <span class="n">DeviceFlowManager</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;once&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Define-global-variables">Define global variables<a class="anchor-link" href="#Define-global-variables"> </a></h3><p>Similar to import we like to define notebook variable at the top and reuse them throughout the notebook</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">data_store</span> <span class="o">=</span> <span class="s2">&quot;https://data.testing.rrap-is.com&quot;</span>
<span class="n">data_api</span> <span class="o">=</span> <span class="s2">&quot;https://data-api.testing.rrap-is.com&quot;</span>
<span class="n">registry_api</span> <span class="o">=</span> <span class="s2">&quot;https://registry-api.testing.rrap-is.com&quot;</span>
<span class="n">prov_api</span> <span class="o">=</span> <span class="s2">&quot;https://prov-api.testing.rrap-is.com&quot;</span>
<span class="n">auth_server</span> <span class="o">=</span> <span class="s2">&quot;https://auth.dev.rrap-is.com/auth/realms/rrap&quot;</span>
<span class="c1"># garbage = &quot;https://frogs.are.green&quot;</span>
<span class="n">base_urls</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;data_api&#39;</span><span class="p">:</span> <span class="n">data_api</span><span class="p">,</span> <span class="s1">&#39;registry_api&#39;</span><span class="p">:</span> <span class="n">registry_api</span><span class="p">,</span> <span class="s1">&#39;prov_api&#39;</span><span class="p">:</span> <span class="n">prov_api</span><span class="p">,</span> <span class="s1">&#39;auth_server&#39;</span><span class="p">:</span> <span class="n">auth_server</span><span class="p">,</span> <span class="s1">&#39;data_store&#39;</span><span class="p">:</span> <span class="n">data_store</span><span class="p">}</span><span class="c1">#, &#39;garbage&#39;: garbage}</span>
<span class="n">display</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Checking base urls&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">base_urls</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Testing - </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; - Passed&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">HTTPError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; - Fail&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># catastrophic error. bail.</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; - Fail&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea ">
<pre>&#39;Checking base urls&#39;</pre>
</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Testing - https://data-api.testing.rrap-is.com - Passed
Testing - https://registry-api.testing.rrap-is.com - Passed
Testing - https://prov-api.testing.rrap-is.com - Passed
Testing - https://auth.dev.rrap-is.com/auth/realms/rrap - Passed
Testing - https://data.testing.rrap-is.com - Passed
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Authentication">Authentication<a class="anchor-link" href="#Authentication"> </a></h2><h3 id="Setup-tokens-using-device-authorisation-flow-against-keycloak-server">Setup tokens using device authorisation flow against keycloak server<a class="anchor-link" href="#Setup-tokens-using-device-authorisation-flow-against-keycloak-server"> </a></h3><p>This could result in a browser window being opened if you don't have valid tokens cached in local storage.</p>
<p><a href="#toc">Return to Top</a></p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-python"><pre><span></span><span class="n">local_token_storage</span> <span class="o">=</span> <span class="s2">&quot;.tokens.json&quot;</span>

<span class="n">token_manager</span> <span class="o">=</span> <span class="n">DeviceFlowManager</span><span class="p">(</span>
    <span class="n">stage</span><span class="o">=</span><span class="s2">&quot;TEST&quot;</span><span class="p">,</span>
    <span class="n">keycloak_endpoint</span><span class="o">=</span><span class="n">auth_server</span><span class="p">,</span>
    <span class="n">local_storage_location</span><span class="o">=</span><span class="n">local_token_storage</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Endpoint-Documentation">Endpoint Documentation<a class="anchor-link" href="#Endpoint-Documentation"> </a></h2><p>Endpoint documentation can be found by appending either <code>/docs</code> or <code>/redoc</code> on the end a base URL.</p>
<p>For example:</p>
<ul>
  <li><a href="https://prov-api.testing.rrap-is.com/redoc" target="_blank">Provenance API</a></li>
  <li><a href="https://data-api.testing.rrap-is.com/redoc" target="_blank">Data API</a></li>
  <li><a href="https://registry-api.testing.rrap-is.com/redoc" target="_blank">Registry API</a></li>
</ul><p>Then select from the menu an endpoint function call e.g. <code>/register/mint-dataset</code></p>
<p>Then append the function call onto the base url e.g. <code>https://data-api.testing.rrap-is.com/register/mint-dataset</code></p>
<p><a href="#toc">Return to Top</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Demonstration">Demonstration<a class="anchor-link" href="#Demonstration"> </a></h2><p>This demonstration illustrates how the RRAP-IS system can be integrated within a modelling scenario to use registered project data, upload and register model outputs and discover provenance information (what data was used for a particular model run and what are the associated outputs).</p>
<p>For the demonstration a fictitious model is used, the data is actual RRAP data and the provenance information is only</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Model">Model<a class="anchor-link" href="#Model"> </a></h3><p>We should be able to discover a model within the Registry or we can register a new model. First we will show how to list existing registered models and then we will demonstrate registering a new model.  Then we will use the registery to obtain a model.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="List-all-existing-models">List all existing models<a class="anchor-link" href="#List-all-existing-models"> </a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Register-a-new-model">Register a new model<a class="anchor-link" href="#Register-a-new-model"> </a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Obtain-the-newly-Registered-Model-for-use">Obtain the newly Registered Model for use<a class="anchor-link" href="#Obtain-the-newly-Registered-Model-for-use"> </a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Data">Data<a class="anchor-link" href="#Data"> </a></h3><p>Similar to models we should use registered data else we should register new data and then use the registry to obtain the data.  We will demonstrate listing existing dataset and registering a new dataset.  Finally we will demonstrate using the registry to obtain data for a model run, register the run and the results/outputs from the run along with who (Modeller and Organisation) ran the model.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="List-existing-datasets">List existing datasets<a class="anchor-link" href="#List-existing-datasets"> </a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Register-a-new-dataset">Register a new dataset<a class="anchor-link" href="#Register-a-new-dataset"> </a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Download-and-use-a-registered-dataset">Download and use a registered dataset<a class="anchor-link" href="#Download-and-use-a-registered-dataset"> </a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Execute-the-model-and-register-the-outputs">Execute the model and register the outputs<a class="anchor-link" href="#Execute-the-model-and-register-the-outputs"> </a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Provenance">Provenance<a class="anchor-link" href="#Provenance"> </a></h3><p>As all data, modellers, organisations and activities (<strong>specific to producing data used in decisions</strong>) are registered in RRAP-IS it is possible to travers the linage between these entities.  This can be useful in discovering what data (or modeller/model/s) was used to produce certain outputs.</p>

</div>
</div>
</div>
</div>
 

